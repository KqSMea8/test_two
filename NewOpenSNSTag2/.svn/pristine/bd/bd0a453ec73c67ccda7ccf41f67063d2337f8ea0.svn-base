<?php

namespace Enterprise\Service;

//use Wechat\Model\PrinterFaultRecordModel;
//use Wechat\Model\StoreManagerBindStoreModel;
//use Wechat\Model\MessageReminderModel;
use Think\Log;
use Wechat\Model\WechatMemberModel;
use Wechat\Model\WechatOrderModel;

/**
 * å¾®ä¿¡ä¼ä¸šå·
 *
 * @author songbin
 *
 */
include_once "php/WXBizMsgCrypt.php";

class EnterpriseService
{
    private $encodingAesKey;
    private $token;
    private $corpId;
    private $corpsecret;
    private $_accessToken = null;
    private $_jsapiTicket = null;
    const GET_ACCESS_TOKEN_URL = "https://qyapi.weixin.qq.com/cgi-bin/gettoken?";
    const GET_USER_INFO_URL = "https://qyapi.weixin.qq.com/cgi-bin/user/getuserinfo?";
    const GET_USER_URL = "https://qyapi.weixin.qq.com/cgi-bin/user/get?";
    const GET_MEDIA_URL = "https://qyapi.weixin.qq.com/cgi-bin/media/get?";
    const GET_DEPARTMENT_LIST = "https://qyapi.weixin.qq.com/cgi-bin/department/list?";
    const GET_DEPARTMENT_USER_SIMPLE_LIST = "https://qyapi.weixin.qq.com/cgi-bin/user/simplelist?";
    const GET_DEPARTMENT_USER_LIST = "https://qyapi.weixin.qq.com/cgi-bin/user/list?";
    const MEDIA_UPLOAD = "https://qyapi.weixin.qq.com/cgi-bin/media/upload?";
    const SEND_MESSAGE = "https://qyapi.weixin.qq.com/cgi-bin/message/send?";
    const GET_JS_API_TICKET_URL = "https://qyapi.weixin.qq.com/cgi-bin/get_jsapi_ticket?";
    const GET_CODE = "https://open.weixin.qq.com/connect/oauth2/authorize?";
    const USER_CREATE_URL = "https://qyapi.weixin.qq.com/cgi-bin/user/create?";
    const USER_UPDATE_URL = "https://qyapi.weixin.qq.com/cgi-bin/user/update?";
    const USER_DELETE_URL = "https://qyapi.weixin.qq.com/cgi-bin/user/delete?";
    const USER_BATCHDELETE_URL = "https://qyapi.weixin.qq.com/cgi-bin/user/batchdelete?";
    const INVITE_SEND_URL = "https://qyapi.weixin.qq.com/cgi-bin/invite/send?";

    const CUSTOMER_SERVICE = COMPANY_CUSTOMER_SERVICE;
    const REPAIRE_MASTER = COMPANY_REPAIRE_MASTER;
    const CLEANING_MASTER = COMPANY_CLEANING_MASTER;
    const CLEANKILL_MASTER = COMPANY_CLEANKILL_MASTER;
    const DISTRIBUTE_MANAGER = COMPANY_DISTRIBUTE_MANAGER;

    //1ï¼šé—¨åº—ç”¨æˆ· 2ï¼šé—¨åº—æ¶ˆæ€ 3ï¼š è®¾å¤‡ç»´ä¿® 4ï¼šçƒŸé“æ¸…æ´— 5ï¼šå®¢æœ
    const TYPE_USER_CUSTOMER = 1;
    const TYPE_USER_CLEANKILL = 2;
    const TYPE_USER_REPAIRE = 3;
    const TYPE_USER_CLEANING = 4;
    const TYPE_USER_SERVICE = 5;
    //0ä¸æ˜¯, 1åˆ†é…ä¸»ç®¡ 2å®¢æœ
    const ADMIN_NOMAL = 0;
    const ADMIN_DISTRIBUTE = 1;
    const ADMIN_SERVICE = 2;

    private $dtuInterfaceUrl = "http://p.lz517.net:8080/Printer/getPrinterState";
    private $dtuInterfaceUrlTest = "http://p.lz517.net:8080/PrinterTask/test";

    public function inviteSend($userId){
        $param = ['userid' => $userId];
        $accessToken = $this->getAccessToken();
        $result = $this->httpPost(self::INVITE_SEND_URL . 'access_token=' . $accessToken,json_encode($param) );
        return $result;
    }

    /**
     * @param $userIdList
     * @return string
     */
    public function userBatchDelete($userIdList){
        $param = ['useridlist' => $userIdList];
        $accessToken = $this->getAccessToken();
        $result = $this->httpPost(self::USER_BATCHDELETE_URL . 'access_token=' . $accessToken,json_encode($param) );
        return $result;
    }

    /**
     * @param $userId
     * @return Ambigous
     */
    public function userDelete($userId){
        $accessToken = $this->getAccessToken();
        $result = $this->httpGet(self::USER_DELETE_URL . 'access_token=' . $accessToken . "&userid=" . $userId);
        return $result;
    }

    /**
     * @param $param
     * {
        "userid": "zhangsan",
        "name": "æå››",
        "department": [1],
        "position": "åå°å·¥ç¨‹å¸ˆ",
        "mobile": "15913215421",
        "gender": "1",
        "email": "zhangsan@gzdev.com",
        "weixinid": "lisifordev",
        "enable": 1,
        "avatar_mediaid": "2-G6nrLmr5EC3MNb_-zL1dDdzkd0p7cNliYu9V5w7o8K0",
        "extattr": {"attrs":[{"name":"çˆ±å¥½","value":"æ—…æ¸¸"},{"name":"å¡å·","value":"1234567234"}]}
        }
     * @return Ambigous
     */
    public function userUpdate($param){
        $accessToken = $this->getAccessToken();
        $result = $this->httpPost(self::USER_UPDATE_URL . 'access_token=' . $accessToken,json_encode($param) );
        return $result;
    }

    /**
     * æ·»åŠ ç”¨æˆ·
     * @param $param
     * {
        "userid": "zhangsan",
        "name": "å¼ ä¸‰",
        "department": [1, 2],
        "position": "äº§å“ç»ç†",
        "mobile": "15913215421",
        "gender": "1",
        "email": "zhangsan@gzdev.com",
        "weixinid": "zhangsan4dev",
        "avatar_mediaid": "2-G6nrLmr5EC3MNb_-zL1dDdzkd0p7cNliYu9V5w7o8K0",
        "extattr": {"attrs":[{"name":"çˆ±å¥½","value":"æ—…æ¸¸"},{"name":"å¡å·","value":"1234567234"}]}
        }
     * @return Ambigous
     */
    public function userCreate($param){
        $accessToken = $this->getAccessToken();
        $result = $this->httpPost(self::USER_CREATE_URL . 'access_token=' . $accessToken,json_encode($param) );
        return $result;
    }

    // æ„é€ å‡½æ•°
    public function __construct($encodingAesKey, $token, $corpId = COMPANY_CORPID, $corpsecret)
    {
        $this->encodingAesKey = $encodingAesKey;
        $this->token = $token;
        $this->corpId = $corpId;
        $this->corpsecret = $corpsecret;
    }

    /**
     * éªŒè¯å›è°ƒURL
     */
    public function verifyURL()
    {

        /*
         * ------------ä½¿ç”¨ç¤ºä¾‹ä¸€ï¼šéªŒè¯å›è°ƒURL---------------
         * ä¼ä¸šå¼€å¯å›è°ƒæ¨¡å¼æ—¶ï¼Œä¼ä¸šå·ä¼šå‘éªŒè¯urlå‘é€ä¸€ä¸ªgetè¯·æ±‚
         * å‡è®¾ç‚¹å‡»éªŒè¯æ—¶ï¼Œä¼ä¸šæ”¶åˆ°ç±»ä¼¼è¯·æ±‚ï¼š
         * GET /cgi-bin/wxpush?msg_signature=5c45ff5e21c57e6ad56bac8758b79b1d9ac89fd3&timestamp=1409659589&nonce=263014780&echostr=P9nAzCzyDtyTWESHep1vC5X9xho%2FqYX3Zpb4yKa9SKld1DsH3Iyt3tP3zNdtp%2B4RPcs8TgAE7OaBO%2BFZXvnaqQ%3D%3D
         * HTTP/1.1 Host: qy.weixin.qq.com
         *
         * æ¥æ”¶åˆ°è¯¥è¯·æ±‚æ—¶ï¼Œä¼ä¸šåº”
         * 1.è§£æå‡ºGetè¯·æ±‚çš„å‚æ•°ï¼ŒåŒ…æ‹¬æ¶ˆæ¯ä½“ç­¾å(msg_signature)ï¼Œæ—¶é—´æˆ³(timestamp)ï¼Œéšæœºæ•°å­—ä¸²(nonce)ä»¥åŠå…¬ä¼—å¹³å°æ¨é€è¿‡æ¥çš„éšæœºåŠ å¯†å­—ç¬¦ä¸²(echostr),
         * è¿™ä¸€æ­¥æ³¨æ„ä½œURLè§£ç ã€‚
         * 2.éªŒè¯æ¶ˆæ¯ä½“ç­¾åçš„æ­£ç¡®æ€§
         * 3. è§£å¯†å‡ºechostråŸæ–‡ï¼Œå°†åŸæ–‡å½“ä½œGetè¯·æ±‚çš„responseï¼Œè¿”å›ç»™å…¬ä¼—å¹³å°
         * ç¬¬2ï¼Œ3æ­¥å¯ä»¥ç”¨å…¬ä¼—å¹³å°æä¾›çš„åº“å‡½æ•°VerifyURLæ¥å®ç°ã€‚
         *
         */

        // $sVerifyMsgSig = HttpUtils.ParseUrl("msg_signature");
        $sVerifyMsgSig = $_GET ['msg_signature'];
        // $sVerifyTimeStamp = HttpUtils.ParseUrl("timestamp");
        $sVerifyTimeStamp = $_GET ['timestamp'];
        // $sVerifyNonce = HttpUtils.ParseUrl("nonce");
        $sVerifyNonce = $_GET ['nonce'];
        // $sVerifyEchoStr = HttpUtils.ParseUrl("echostr");
        $sVerifyEchoStr = $_GET ['echostr'];

        log::write('æœåŠ¡ç«¯æ¥æ”¶å¾®ä¿¡éªŒè¯æ•°æ® : '.$sVerifyMsgSig." | ".$sVerifyTimeStamp." | ".$sVerifyNonce." | ".$sVerifyEchoStr);
        log::write('æœåŠ¡ç«¯é…ç½®çš„å¾®ä¿¡æ•°æ®: '.$this->token." | ".$this->encodingAesKey." | ".$this->corpId);
        // éœ€è¦è¿”å›çš„æ˜æ–‡
        $EchoStr = "";

        $wxcpt = new \WXBizMsgCrypt ($this->token, $this->encodingAesKey, $this->corpId);
        $errCode = $wxcpt->VerifyURL($sVerifyMsgSig, $sVerifyTimeStamp, $sVerifyNonce, $sVerifyEchoStr, $sEchoStr);

        log::write('å¾®ä¿¡éªŒè¯ç»“æœä¸º | '.$errCode);
        if ($errCode == 0) {
            //
            // éªŒè¯URLæˆåŠŸï¼Œå°†sEchoStrè¿”å›
            echo $sEchoStr;
            // HttpUtils.SetResponce($sEchoStr);
        } else {
            print ("ERR: " . $errCode . "\n\n");
        }
    }

    /**
     * æ¶ˆæ¯è§£å¯†
     */
    public function decrypt()
    {
        /*
         * ------------ä½¿ç”¨ç¤ºä¾‹äºŒï¼šå¯¹ç”¨æˆ·å›å¤çš„æ¶ˆæ¯è§£å¯†---------------
         * ç”¨æˆ·å›å¤æ¶ˆæ¯æˆ–è€…ç‚¹å‡»äº‹ä»¶å“åº”æ—¶ï¼Œä¼ä¸šä¼šæ”¶åˆ°å›è°ƒæ¶ˆæ¯ï¼Œæ­¤æ¶ˆæ¯æ˜¯ç»è¿‡å…¬ä¼—å¹³å°åŠ å¯†ä¹‹åçš„å¯†æ–‡ä»¥postå½¢å¼å‘é€ç»™ä¼ä¸šï¼Œå¯†æ–‡æ ¼å¼è¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£
         * å‡è®¾ä¼ä¸šæ”¶åˆ°å…¬ä¼—å¹³å°çš„å›è°ƒæ¶ˆæ¯å¦‚ä¸‹ï¼š
         * POST /cgi-bin/wxpush? msg_signature=477715d11cdb4164915debcba66cb864d751f3e6&timestamp=1409659813&nonce=1372623149 HTTP/1.1
         * Host: qy.weixin.qq.com
         * Content-Length: 613
         * <xml>
         * <ToUserName><![CDATA[wx5823bf96d3bd56c7]]></ToUserName><Encrypt><![CDATA[RypEvHKD8QQKFhvQ6QleEB4J58tiPdvo+rtK1I9qca6aM/wvqnLSV5zEPeusUiX5L5X/0lWfrf0QADHHhGd3QczcdCUpj911L3vg3W/sYYvuJTs3TUUkSUXxaccAS0qhxchrRYt66wiSpGLYL42aM6A8dTT+6k4aSknmPj48kzJs8qLjvd4Xgpue06DOdnLxAUHzM6+kDZ+HMZfJYuR+LtwGc2hgf5gsijff0ekUNXZiqATP7PF5mZxZ3Izoun1s4zG4LUMnvw2r+KqCKIw+3IQH03v+BCA9nMELNqbSf6tiWSrXJB3LAVGUcallcrw8V2t9EL4EhzJWrQUax5wLVMNS0+rUPA3k22Ncx4XXZS9o0MBH27Bo6BpNelZpS+/uh9KsNlY6bHCmJU9p8g7m3fVKn28H3KDYA5Pl/T8Z1ptDAVe0lXdQ2YoyyH2uyPIGHBZZIs2pDBS8R07+qN+E7Q==]]></Encrypt>
         * <AgentID><![CDATA[218]]></AgentID>
         * </xml>
         *
         * ä¼ä¸šæ”¶åˆ°postè¯·æ±‚ä¹‹ååº”è¯¥
         * 1.è§£æå‡ºurlä¸Šçš„å‚æ•°ï¼ŒåŒ…æ‹¬æ¶ˆæ¯ä½“ç­¾å(msg_signature)ï¼Œæ—¶é—´æˆ³(timestamp)ä»¥åŠéšæœºæ•°å­—ä¸²(nonce)
         * 2.éªŒè¯æ¶ˆæ¯ä½“ç­¾åçš„æ­£ç¡®æ€§ã€‚
         * 3.å°†postè¯·æ±‚çš„æ•°æ®è¿›è¡Œxmlè§£æï¼Œå¹¶å°†<Encrypt>æ ‡ç­¾çš„å†…å®¹è¿›è¡Œè§£å¯†ï¼Œè§£å¯†å‡ºæ¥çš„æ˜æ–‡å³æ˜¯ç”¨æˆ·å›å¤æ¶ˆæ¯çš„æ˜æ–‡ï¼Œæ˜æ–‡æ ¼å¼è¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£
         * ç¬¬2ï¼Œ3æ­¥å¯ä»¥ç”¨å…¬ä¼—å¹³å°æä¾›çš„åº“å‡½æ•°DecryptMsgæ¥å®ç°ã€‚
         */

        // $sReqMsgSig = HttpUtils.ParseUrl("msg_signature");
        $sReqMsgSig = $_GET ['msg_signature'];
        // $sReqTimeStamp = HttpUtils.ParseUrl("timestamp");
        $sReqTimeStamp = $_GET ['timestamp'];
        // $sReqNonce = HttpUtils.ParseUrl("nonce");
        $sReqNonce = $_GET ['nonce'];
        // postè¯·æ±‚çš„å¯†æ–‡æ•°æ®
        // $sReqData = HttpUtils.PostData();
        $sReqData = $GLOBALS['HTTP_RAW_POST_DATA'];

        $sMsg = ""; // è§£æä¹‹åçš„æ˜æ–‡
        $wxcpt = new \WXBizMsgCrypt ($this->token, $this->encodingAesKey, $this->corpId);
        $errCode = $wxcpt->DecryptMsg($sReqMsgSig, $sReqTimeStamp, $sReqNonce, $sReqData, $sMsg);

        if ($errCode == 0) {
            // è§£å¯†æˆåŠŸï¼ŒsMsgå³ä¸ºxmlæ ¼å¼çš„æ˜æ–‡
            // TODO: å¯¹æ˜æ–‡çš„å¤„ç†
            // For example:
            if (!empty ($sMsg)) {
                libxml_disable_entity_loader(true);
                $this->_receive = ( array )simplexml_load_string($sMsg, 'SimpleXMLElement', LIBXML_NOCDATA);
                return $this->_receive;
            }
            return null;
        } else {
        }
    }

    /**
     * åŠ å¯†æ¶ˆæ¯å¹¶å‘é€
     */
    public function encrypt($sRespData)
    {
        /*
         * ------------ä½¿ç”¨ç¤ºä¾‹ä¸‰ï¼šä¼ä¸šå›å¤ç”¨æˆ·æ¶ˆæ¯çš„åŠ å¯†---------------
         * ä¼ä¸šè¢«åŠ¨å›å¤ç”¨æˆ·çš„æ¶ˆæ¯ä¹Ÿéœ€è¦è¿›è¡ŒåŠ å¯†ï¼Œå¹¶ä¸”æ‹¼æ¥æˆå¯†æ–‡æ ¼å¼çš„xmlä¸²ã€‚
         * å‡è®¾ä¼ä¸šéœ€è¦å›å¤ç”¨æˆ·çš„æ˜æ–‡å¦‚ä¸‹ï¼š
         * <xml>
         * <ToUserName><![CDATA[mycreate]]></ToUserName>
         * <FromUserName><![CDATA[wx5823bf96d3bd56c7]]></FromUserName>
         * <CreateTime>1348831860</CreateTime>
         * <MsgType><![CDATA[text]]></MsgType>
         * <Content><![CDATA[this is a test]]></Content>
         * <MsgId>1234567890123456</MsgId>
         * <AgentID>128</AgentID>
         * </xml>
         *
         * ä¸ºäº†å°†æ­¤æ®µæ˜æ–‡å›å¤ç»™ç”¨æˆ·ï¼Œä¼ä¸šåº”ï¼š
         * 1.è‡ªå·±ç”Ÿæˆæ—¶é—´æ—¶é—´æˆ³(timestamp),éšæœºæ•°å­—ä¸²(nonce)ä»¥ä¾¿ç”Ÿæˆæ¶ˆæ¯ä½“ç­¾åï¼Œä¹Ÿå¯ä»¥ç›´æ¥ç”¨ä»å…¬ä¼—å¹³å°çš„post urlä¸Šè§£æå‡ºçš„å¯¹åº”å€¼ã€‚
         * 2.å°†æ˜æ–‡åŠ å¯†å¾—åˆ°å¯†æ–‡ã€‚
         * 3.ç”¨å¯†æ–‡ï¼Œæ­¥éª¤1ç”Ÿæˆçš„timestamp,nonceå’Œä¼ä¸šåœ¨å…¬ä¼—å¹³å°è®¾å®šçš„tokenç”Ÿæˆæ¶ˆæ¯ä½“ç­¾åã€‚
         * 4.å°†å¯†æ–‡ï¼Œæ¶ˆæ¯ä½“ç­¾åï¼Œæ—¶é—´æˆ³ï¼Œéšæœºæ•°å­—ä¸²æ‹¼æ¥æˆxmlæ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œå‘é€ç»™ä¼ä¸šå·ã€‚
         * ä»¥ä¸Š2ï¼Œ3ï¼Œ4æ­¥å¯ä»¥ç”¨å…¬ä¼—å¹³å°æä¾›çš„åº“å‡½æ•°EncryptMsgæ¥å®ç°ã€‚
         */
        $sReqTimeStamp = time();
        $sReqNonce = $this->createNonceStr();
        $sEncryptMsg = ""; // xmlæ ¼å¼çš„å¯†æ–‡
        $wxcpt = new \WXBizMsgCrypt ($this->token, $this->encodingAesKey, $this->corpId);
        $errCode = $wxcpt->EncryptMsg($sRespData, $sReqTimeStamp, $sReqNonce, $sEncryptMsg);
        if ($errCode == 0) {
            echo $sEncryptMsg;
        } else {
        }
    }

    /**
     * å›å¤æ–‡æœ¬æ¶ˆæ¯ï¼ˆè¢«åŠ¨ï¼‰
     */
    public function responsePassiveText($content)
    {
        $xmlTpl = "<xml>
                        <ToUserName><![CDATA[" . $this->getRev('FromUserName') . "]]></ToUserName>
                        <FromUserName><![CDATA[" . $this->getRev('ToUserName') . "]]></FromUserName>
                        <CreateTime>" . time() . "</CreateTime>
                        <MsgType><![CDATA[text]]></MsgType>
                        <Content><![CDATA[" . $content . "]]></Content>
                    </xml>";
        $this->encrypt($xmlTpl);
    }

    /**
     * è·å–16ä½éšæœºå­—ç¬¦ä¸²
     *
     * @param number $length
     * @return string
     */
    private function createNonceStr($length = 16)
    {
        $chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        $str = "";
        for ($i = 0; $i < $length; $i++) {
            $str .= substr($chars, mt_rand(0, strlen($chars) - 1), 1);
        }
        return $str;
    }

    /**
     * GET è¯·æ±‚
     *
     * @param string $url
     */
    private function httpGet($url)
    {
        $oCurl = curl_init();
        if (stripos($url, "https://") !== FALSE) {
            curl_setopt($oCurl, CURLOPT_SSL_VERIFYPEER, FALSE);
            curl_setopt($oCurl, CURLOPT_SSL_VERIFYHOST, FALSE);
        }
        curl_setopt($oCurl, CURLOPT_URL, $url);
        curl_setopt($oCurl, CURLOPT_RETURNTRANSFER, 1);
        $sContent = curl_exec($oCurl);
        $aStatus = curl_getinfo($oCurl);
        curl_close($oCurl);
        if (intval($aStatus ["http_code"]) == 200) {
            return $sContent;
        } else {
            return false;
        }
    }

    /**
     * POST è¯·æ±‚
     *
     * @param string $url
     * @param array $param
     * @return string content
     */
    private function httpPost($url, $param, $isArray = false)
    {
        $oCurl = curl_init();
        curl_setopt ( $oCurl, CURLOPT_SAFE_UPLOAD, false);
        if (stripos($url, "https://") !== FALSE) {
            curl_setopt($oCurl, CURLOPT_SSL_VERIFYPEER, FALSE);
            curl_setopt($oCurl, CURLOPT_SSL_VERIFYHOST, false);
        }
        if (!$isArray) {
            if (is_string($param)) {
                $strPOST = $param;
            } else {
                $aPOST = array();
                foreach ($param as $key => $val) {
                    $aPOST [] = $key . "=" . urlencode($val);
                }
                $strPOST = join("&", $aPOST);
            }
        } else {
            $strPOST = $param;
        }
        curl_setopt($oCurl, CURLOPT_URL, $url);
        curl_setopt($oCurl, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($oCurl, CURLOPT_POST, true);
        curl_setopt($oCurl, CURLOPT_POSTFIELDS, $strPOST);
        $sContent = curl_exec($oCurl);
        $aStatus = curl_getinfo($oCurl);

        curl_close($oCurl);

        if (intval($aStatus ["http_code"]) == 200) {
            return $sContent;
        } else {
            return false;
        }
    }

    /**
     * è§£æå¾®ä¿¡è¿”å›çš„jsonæ•°æ®
     *
     * @param unknown $result
     * @return Ambigous <NULL, mixed>
     */
    private function decodeJson($result)
    {
        $arr = null;
        if ($result) {
            $arr = json_decode($result, true);
            if ($arr && array_key_exists('errcode', $arr)) {
                $this->errCode = $arr ['errcode'];
                $this->errMsg = $arr ['errmsg'];
            }
        }
        return $arr;
    }

    /**
     * è§£æPOSTè¿‡æ¥çš„XMLä¿¡æ¯
     *
     * @return NULL
     */
    public function parseMsg()
    {
        // è§£å¯†
        $this->decrypt();
    }

    /**
     * è·å–è§£æåçš„XMLæ•°æ®ä¸­ä¿¡æ¯
     *
     * @param unknown $name
     *            ä¸ºallæ—¶è¿”å›æ•´ä¸ªæ•°ç»„
     * @return NULL
     */
    public function getRev($name)
    {
        if ($name == 'all') {
            return $this->_receive;
        }
        if (is_array($this->_receive) && array_key_exists($name, $this->_receive)) {
            return $this->_receive [$name];
        }
        return null;
    }

    /**
     * è·å–access_token
     *
     * @return \Wechat\Service\Ambigous
     */
    public function getAccessToken()
    {
        if (is_null($this->_accessToken)) {
            $this->_accessToken = S($this->corpsecret);
            if (!$this->_accessToken) {
                $result = $this->httpGet(self::GET_ACCESS_TOKEN_URL . 'corpid=' . $this->corpId . '&corpsecret=' . $this->corpsecret);
                Log::write("è·å–accessâ€”â€”token".$result);
                $json = $this->decodeJson($result);
                if (array_key_exists('access_token', $json)) {
                    $this->_accessToken = $json ['access_token'];
                    S($this->corpsecret, $json ['access_token'], 3600);
                }
            }
        }
        return $this->_accessToken;
    }

    /**
     * è·å–å‘˜å·¥
     *
     * @param unknown $corpsecret
     * @param unknown $code
     * @param unknown $agentid
     */
    Public function getUserInfo($code, $agentid)
    {
        $accessToken = $this->getAccessToken();
        $result = $this->httpGet(self::GET_USER_INFO_URL . 'access_token=' . $accessToken . '&code=' . $code . '&agentid=' . $agentid);
        return $this->decodeJson($result);
    }

    /**
     * æ ¹æ®è·å–å‘˜å·¥ä¿¡æ¯
     *
     * @param unknown $userId
     * @param unknown $corpsecret
     * @return \Wechat\Service\Ambigous
     */
    public function getUserById($userId)
    {
        $accessToken = $this->getAccessToken();
        $result = $this->httpGet(self::GET_USER_URL . 'access_token=' . $accessToken . '&userid=' . $userId);
        $result = $this->decodeJson($result);
        return $result;
    }

    /**
     * ä¸‹è½½å¤šåª’ä½“æ–‡ä»¶
     *
     * @param string $dirname
     *            å›¾ç‰‡ä¿å­˜åœ°å€ï¼Œé»˜è®¤ä¿å­˜åˆ°å¯¼è´­
     * @param unknown $corpsecret
     * @param unknown $mediaId
     * @return string
     */
    public function saveMedia($mediaId, $dirname = "./Uploads/wx_shoppingGuide/")
    {
        set_time_limit(C('MAX_RUN_TIME'));
        $accessToken = $this->getAccessToken();
        $url = self::GET_MEDIA_URL . 'access_token=' . $accessToken . '&media_id=' . $mediaId;
        $ch = curl_init($url);
        curl_setopt($ch, CURLOPT_HEADER, 0);
        curl_setopt($ch, CURLOPT_NOBODY, 0); // å¯¹bodyè¿›è¡Œè¾“å‡ºã€‚
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE);
        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, FALSE);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        $package = curl_exec($ch);
        $httpinfo = curl_getinfo($ch);
        curl_close($ch);

        $media = array_merge(array(
            'mediaBody' => $package
        ), $httpinfo);

        // æ±‚å‡ºæ–‡ä»¶æ ¼å¼
        preg_match('/\w\/(\w+)/i', $media ["content_type"], $extmatches);
        $fileExt = $extmatches [1];
        $filename = time() . rand(100, 999) . ".{$fileExt}";
        if (!file_exists($dirname)) {
            mkdir($dirname, 0777, true);
        }
        file_put_contents($dirname . $filename, $media ['mediaBody']);
        return $dirname . $filename;
    }

    /**
     * è·å–éƒ¨é—¨åˆ—è¡¨
     * @param $corpsecret
     * @param int $departmentId éƒ¨é—¨idï¼Œé»˜è®¤ä¸º1ï¼ˆå…¨ä¼ä¸šï¼‰
     * @return bool|mixed|Ambigous
     */
    public function getDepartmentList($departmentId = 1)
    {
        $accessToken = $this->getAccessToken();
        $result = $this->httpGet(self::GET_DEPARTMENT_LIST . 'access_token=' . $accessToken . '&id=' . $departmentId);
        $result = $this->decodeJson($result);
        return $result;
    }

    /**
     * è·å–éƒ¨é—¨æˆå‘˜ç®€å•åˆ—è¡¨
     * @param $corpsecret
     * @param $departmentId éƒ¨é—¨id
     * @param int $fetch_child æ˜¯å¦é€’å½’è·å–å­æˆå‘˜ 1æ˜¯2å¦
     * @param int $status 0è·å–å…¨éƒ¨æˆå‘˜ï¼Œ1è·å–å·²å…³æ³¨æˆå‘˜åˆ—è¡¨ï¼Œ2è·å–ç¦ç”¨æˆå‘˜åˆ—è¡¨ï¼Œ4è·å–æœªå…³æ³¨æˆå‘˜åˆ—è¡¨ã€‚statuså¯å åŠ 
     * @return bool|mixed|Ambigous
     */
    public function getDepartmentUserSimpleList($departmentId = 1, $fetch_child = 1, $status = 0)
    {
        $accessToken = $this->getAccessToken();
        $result = $this->httpGet(self::GET_DEPARTMENT_USER_SIMPLE_LIST . 'access_token=' . $accessToken . '&department_id=' . $departmentId . '&fetch_child=' . $fetch_child . '&status=' . $status);
        $result = $this->decodeJson($result);
        return $result;
    }

    /**
     * è·å–éƒ¨é—¨æˆå‘˜è¯¦ç»†åˆ—è¡¨
     * @param $corpsecret
     * @param $departmentId éƒ¨é—¨id
     * @param int $fetch_child æ˜¯å¦é€’å½’è·å–å­æˆå‘˜ 1æ˜¯2å¦
     * @param int $status 0è·å–å…¨éƒ¨æˆå‘˜ï¼Œ1è·å–å·²å…³æ³¨æˆå‘˜åˆ—è¡¨ï¼Œ2è·å–ç¦ç”¨æˆå‘˜åˆ—è¡¨ï¼Œ4è·å–æœªå…³æ³¨æˆå‘˜åˆ—è¡¨ã€‚statuså¯å åŠ 
     * @return bool|mixed|Ambigous
     */
    public function getDepartmentUserList($departmentId = 1, $fetch_child = 1, $status = 0)
    {
        $accessToken = $this->getAccessToken();
        $result = $this->httpGet(self::GET_DEPARTMENT_USER_LIST . 'access_token=' . $accessToken . '&department_id=' . $departmentId . '&fetch_child=' . $fetch_child . '&status=' . $status);
        $result = $this->decodeJson($result);
        return $result;
    }

    /**
     * ä¸Šä¼ åª’ä½“æ–‡ä»¶
     * @param $type ç±»å‹
     * @param $media array('media'=>"@media.jpg")
     * @return string|Ambigous
     */
    public function mediaUpload($type, $media)
    {
        $accessToken = $this->getAccessToken();
        $result = $this->httpPost(self::MEDIA_UPLOAD . 'access_token=' . $accessToken . '&type=' . $type, $media, true);
        $result = $this->decodeJson($result);
        return $result;
    }

    public function sendMessage($param){
        $accessToken = $this->getAccessToken();
        Log::write("å‘æ¶ˆæ¯è¿”å›æ•°æ®".$accessToken);
        $result = $this->httpPost(self::SEND_MESSAGE . 'access_token=' . $accessToken,$param);
        Log::write("å‘æ¶ˆæ¯è¿”å›æ•°æ®".$result);
        $result = $this->decodeJson($result);
        return $result;
    }
    
    /**
     * è·å–code
     */
    public function getUserCode($url){
        $appId = $this->corpId;
        return self::GET_CODE . 'appid='.$appId.'&redirect_uri='.$url.'&response_type=code&scope=snsapi_base&state=getCode#wechat_redirect';
    }
    
    /**
     * æ ¹æ®codeè·å–userid
     */
    public function getUserId($code){
        $accessToken = $this->getAccessToken();
        $result = $this->httpGet(self::GET_USER_INFO_URL . 'access_token='.$accessToken.'&code=' . $code);
        $result = $this->decodeJson($result);
        return $result;
    }
    
    /**
     * è·å–jsapi_ticket
     * jsapi_ticketæ˜¯ä¼ä¸šå·ç”¨äºè°ƒç”¨å¾®ä¿¡JSæ¥å£çš„ä¸´æ—¶ç¥¨æ®
     * å¼€å‘è€…å¿…é¡»åœ¨è‡ªå·±çš„æœåŠ¡å…¨å±€ç¼“å­˜jsapi_ticket
     */
    public function getJsApiTicket()
    {
        $accessToken = $this->getAccessToken();
        if (is_null($this->_jsapiTicket)) {
            $this->_jsapiTicket = S('qy_jsapiTicket');
            if (!$this->_jsapiTicket) {
                $result = $this->httpGet(self::GET_JS_API_TICKET_URL . 'access_token=' . $accessToken);
                $json = $this->decodeJson($result);
                if (array_key_exists('ticket', $json)) {
                    $this->_jsapiTicket = $json ['ticket'];
                    S('qy_jsapiTicket', $json ['ticket'], 3600);
                }
            }
        }
        return $this->_jsapiTicket;
    }
    
    /**
     * è·å–jsapiç­¾å
     *
     * @return multitype:string NULL number unknown
     */
    public function getSignPackage()
    {
        $jsapiTicket = $this->getJsApiTicket();
        $url = "http://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
        $timestamp = time();
        $nonceStr = $this->createNonceStr();
    
        // è¿™é‡Œå‚æ•°çš„é¡ºåºè¦æŒ‰ç…§ key å€¼ ASCII ç å‡åºæ’åº
        $string = "jsapi_ticket=$jsapiTicket&noncestr=$nonceStr&timestamp=$timestamp&url=$url";
    
        $signature = sha1($string);
    
        $signPackage = array(
                "appId" => $this->corpId,
                "nonceStr" => $nonceStr,
                "timestamp" => $timestamp,
                "url" => $url,
                "signature" => $signature,
                "rawString" => $string
        );
        return $signPackage;
    }
    
    /**
     * æ ¹æ®æ—¶é—´/æ—¥æœŸï¼Œè¿”å›æ˜ŸæœŸ
     * @author wuhao
     * @param string $dateTime æŒ‡å®šæ—¥æœŸ
     * @return string $return ä¾‹ï¼š'å‘¨ä¸‰'
     */
    public function getWeek($dateTime) {
        $w = date ( "w", strtotime ( $dateTime ) );
        switch ($w) {
            case '0' :
                return "å‘¨æ—¥";
                break;
            case '1' :
                return "å‘¨ä¸€";
                break;
            case '2' :
                return "å‘¨äºŒ";
                break;
            case '3' :
                return "å‘¨ä¸‰";
                break;
            case '4' :
                return "å‘¨å››";
                break;
            case '5' :
                return "å‘¨äº”";
                break;
            case '6' :
                return "å‘¨å…­";
                break;
            default :
                return "";
                break;
        }
    }
    
    /**
     * æ ¹æ®userIdè·å–dtucode(ä¼ä¸šå·ï¼šå•†å®¶åå°)
     * @author wuhao
     * @param string $userId ä¼ä¸šå·ç”¨æˆ·æ‰‹æœºå·
     * @return string $dtucode ä¸è¯¥ç”¨æˆ·ç»‘å®šçš„æ‰“å°æœºcode
     */
    public function getDtucodeByUserId($userId){
        $model = new StoreManagerBindStoreModel();
        $dtucode = $model->where ( "store_manager_userid = '{$userId}'" )->getField ( 'dtucode' );
        return $dtucode;
    }
    
    /**
     * æ ¹æ®dtucodeè·å–æ‰“å°æœºæ•…éšœè®°å½•
     * @auhtor wuhao
     * @param string $dtucode æ‰“å°æœºæ ‡è¯†
     * @return array $printerFaultRecordDataæ‰“å°æœºæ•…éšœè®°å½• ä¾‹ï¼šarray(0=>array('id'=>1,'dtucode'=>æ‰“å°æœºcode,'store_id'=>é—¨åº—id,'reason'=>æ•…éšœåŸå› ,'resolvement'=>è§£å†³æ–¹æ¡ˆ,'ctime'=>åˆ›å»ºæ—¶é—´),1=>array(...),...)
     */
    public function getPrinterFaultDataByDtucode($dtucode){
        $printerFaultModel = new PrinterFaultRecordModel();
        $printerFaultRecordData = $printerFaultModel->where ( "dtu_code = " . $dtucode )->order('ctime desc')->select ();
        return $printerFaultRecordData;
    }
    
    /**
     * æ ¹æ®dtucodeè·å–ä¸é—¨åº—ç»‘å®šçš„æ•°æ®
     * @author wuhao
     * @param string $dtucode æ‰“å°æœºæ ‡è¯†
     * @return array $userIdDataæ‰“å°æœºç»‘å®šä¿¡æ¯ ä¾‹ï¼šarray(0=>array('store_manager_userid'=>é—¨åº—åº—é•¿userIdï¼ˆæ‰‹æœºå·ï¼‰,'dtucode'=>æ‰“å°æœºcode),1=>array(...),...)
     */
    public function getBindDataByDtucode($dtucode){
        $model = new StoreManagerBindStoreModel ();
        $userIdData = $model->where ( "dtucode = " . $dtucode )->select();
        return $userIdData;
    }
    
    /**
     * æ·»åŠ æ‰“å°æœºæ•…éšœè®°å½•
     * @author wuhao
     * @param array $data ä¾‹ï¼šarray('dtucode'=>æ‰“å°æœºcode,'store_id'=>é—¨åº—id,'reason'=>æ•…éšœåŸå› ,'resolvement'=>è§£å†³æ–¹æ¡ˆ,'ctime'=>åˆ›å»ºæ—¶é—´)
     * @return $result å¦‚æœæ•°æ®éæ³•æˆ–è€…æŸ¥è¯¢é”™è¯¯åˆ™è¿”å›falseï¼Œå¦‚æœæ˜¯è‡ªå¢ä¸»é”® åˆ™è¿”å›ä¸»é”®å€¼ï¼Œå¦åˆ™è¿”å›1
     */
    public function addPrinterFaultRecord($data){
        $printerFaultRecordModel = new PrinterFaultRecordModel ();
        $result = $printerFaultRecordModel->add ( $data );
        return $result;
    }

    /**
     * æ·»åŠ æ¶ˆæ¯æé†’è®°å½•
     * @author wuhao
     * @param array $data ä¾‹ï¼šarray('user_id'=>ä½¿ç”¨è€…id,'user_name'=>ä½¿ç”¨è€…å§“å,'content'=>æ¶ˆæ¯æé†’å†…å®¹,'type'=>æ¶ˆæ¯ç±»å‹ï¼ˆtextï¼‰,'create_time'=>åˆ›å»ºæ—¶é—´,'update_time'=>ä¿®æ”¹æ—¶é—´,'from_user'=>ä½¿ç”¨è€…èº«ä»½,'remote_addr'=>ä½¿ç”¨è€…ip)
     * @return å¦‚æœæ•°æ®éæ³•æˆ–è€…æŸ¥è¯¢é”™è¯¯åˆ™è¿”å›falseï¼Œå¦‚æœæ˜¯è‡ªå¢ä¸»é”® åˆ™è¿”å›ä¸»é”®å€¼ï¼Œå¦åˆ™è¿”å›1
     */
    public function addMessageReminder($data){
        $model = new MessageReminderModel();
        $result = $model->add($data);
        return $result;
    }


    /**
     * è°ƒç”¨æ¬§é˜³æ¥å£ï¼Œæµ‹è¯•dtuCode
     */
    public function sendDtuCodeForTest($dtuCode){

        $result = $this->httpPost($this->dtuInterfaceUrl,['dtuCode'=>$dtuCode]);

        return json_decode($result,true);
    }

    public function sendDtuCodeAgain($dtuCode){
        $result = $this->httpPost($this->dtuInterfaceUrlTest,['dtuCode'=>$dtuCode]);

        return json_decode($result,true);
    }

    public function getOrderStatusText($status){
        $text = "";
        //0:æ´¾å•ä¸­;1:å·²æ¥å•;2:å¾…æ”¯ä»˜;3:å·²å®Œæˆ;4:å·²å–æ¶ˆ;5:å·²ç”µè¯è§£å†³;6:å·²é€€æ¬¾;7:å·²è¯„ä»·8:å·²æ”¯ä»˜;9:å¾…éªŒæ”¶;10:æœªæ¥å•)
        switch($status){
            case 0:$text = "æ´¾å•ä¸­";break;
            case 1:$text = "å·²æ¥å•";break;
            case 2:$text = "å¾…æ”¯ä»˜";break;
            case 3:$text = "å·²å®Œæˆ";break;
            case 4:$text = "å·²å–æ¶ˆ";break;
            case 5:$text = "æ— éœ€ä¸Šé—¨";break;
            case 6:$text = "å·²é€€æ¬¾";break;
            case 7:$text = "å·²è¯„ä»·";break;
            case 8:$text = "å·²æ”¯ä»˜";break;
            case 9:$text = "å¾…éªŒæ”¶";break;
            case 10:$text = "æœªæ¥å•";break;
            case 11:$text = "æœåŠ¡ä¸­";break;
            case 12:$text = "å·²è¿‡æœŸ";break;
            case 13:$text = "å¾…ç¡®è®¤";break;
        }
        return $text;
    }
    /**
     * è·å–å®¢æœå‘æ¶ˆæ¯å†…å®¹
     * @param $orderId
     * @param $type
     * @return array|string
     * @author pangyongfu
     */
    public function getCustomerSendMsg($orderId,$type){

        $toUser = null;
        $description = '';
        $agentid = 0;
        $title = '';
        $url = '';
        $wechatOrderModel = new WechatOrderModel();
        $map['orde.id'] = $orderId;
        $field = "orde.id,orde.order_code,orde.order_state,orde.create_time,orde.store_name,item.difference_status,item.difference_status,item.urgent_level,
        orde.order_type,orde.money_total,member.name worker,member.uid,faci.id fid,faci.name fname";
        $repairData = $wechatOrderModel->getDataByOrderId($map,$field);
        $repairData = $repairData[0];
        $repairData['order_type_text'] = $repairData['order_type']==1?"é—¨åº—ç»´ä¿®":($repairData['order_type']==2?"é—¨åº—æ¶ˆæ€":"é—¨åº—æ¸…æ´—");

        $repairData['order_state_text'] = $this->getOrderStatusText($repairData['order_state']);
        $description .= "å·¥å•ç¼–å·ï¼š".$repairData['order_code']."\r\n";
        $description .= "æŠ¥ä¿®é—¨åº—ï¼š".$repairData['store_name']."\r\n";
        $description .= "æŠ¥ä¿®æ—¶é—´ï¼š".$repairData['create_time']."\r\n";
        $description .= "å½“å‰çŠ¶æ€ï¼š".$repairData['order_state_text']."\r\n";
        if($repairData['order_type']==2 && $repairData['order_type']==2){
            $repairData['money_total'] += $repairData['difference_price'];
        }
        //è·å–æ‰€æœ‰å®¢æœäººå‘˜
        $wechatMemberModel = new WechatMemberModel();
        $serviceArr = $wechatMemberModel->where(['isadmin'=>self::ADMIN_SERVICE,'status'=>1,'type_user'=>self::TYPE_USER_SERVICE])->select();

        $serviceArrWxCodeArr = [];
        if(!empty($serviceArr)){
            foreach ($serviceArr as $v) {
                $serviceArrWxCodeArr[] = $v['wx_code'];
            }
        }
        $serviceWxCode = implode("|",$serviceArrWxCodeArr);
        $toUser = $serviceWxCode;
        //å‘é€æ¶ˆæ¯ç±»å‹ 1å®¢æˆ·ä¸‹å•å 2å®¢æˆ·å–æ¶ˆè®¢å• 3å¸ˆå‚…æ¥å•å 4å®¢æˆ·æ”¯ä»˜å 5å®¢æˆ·éªŒæ”¶å®Œæ¯•ï¼ˆæ¶ˆæ€ï¼‰
        switch($type){
            case 1:
                $agentid = self::CUSTOMER_SERVICE;
                $title = "æ–°è®¢å•æé†’ï¼";
                $description = "æ‚¨å¥½ï¼Œ".$repairData['store_name']."æŠ¥ä¿®äº†ä¸€ä¸ªã€".$repairData['order_type_text']."ã€‘çš„è®¢å•ï¼Œè¯·æ“ä½œæ´¾å•ã€ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ã€‘";
                if($repairData['urgent_level'] == 2){
                    $description = "æ‚¨å¥½ï¼Œ".$repairData['store_name']."æŠ¥ä¿®äº†ä¸€ä¸ªã€".$repairData['order_type_text']."ã€‘çš„ğŸ”¥ç´§æ€¥è®¢å•ğŸ”¥ï¼Œå¸ˆå‚…å¿…é¡»åœ¨ğŸ”¥2å°æ—¶å†…ğŸ”¥ä¸Šé—¨ï¼Œè¯·å°½å¿«æ“ä½œæ´¾å•ã€ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ã€‘";
                }
                $url = host_url . "/Enterprise/CustomerServices/orderDetail?type=".$repairData['order_type']."&order_id=".$orderId;
                break;
            case 2://ç»´ä¿®ä¸»ç®¡æœªå¤„ç†è®¢å•
                $agentid = self::CUSTOMER_SERVICE;
                $title = "è®¢å•çŠ¶æ€è¶…æ—¶æé†’ï¼";
                $description = "æ‚¨å¥½ï¼Œè®¢å•å·ä¸ºï¼š".$repairData['order_code']."çš„ã€".$repairData['order_type_text']."ã€‘è®¢å•å°†è¶…è¿‡1å°æ—¶5åˆ†é’Ÿå¯¹æ–¹æœªæ“ä½œï¼Œè¯·çŸ¥æ‚‰ã€ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ã€‘";
                $url = host_url . "/Enterprise/CustomerServices/orderDetail?type=".$repairData['order_type']."&order_id=".$orderId;
                break;
            case 3://æ¶ˆæ€ä¸»ç®¡å’Œæ¸…æ´—ä¸»ç®¡æœªå¤„ç†è®¢å•
            $agentid = self::CUSTOMER_SERVICE;
                $title = "è®¢å•çŠ¶æ€è¶…æ—¶æé†’ï¼";
                $description = "æ‚¨å¥½ï¼Œè®¢å•å·ä¸ºï¼š".$repairData['order_code']."çš„ã€".$repairData['order_type_text']."ã€‘è®¢å•å°†è¶…è¿‡2å°æ—¶å¯¹æ–¹æœªæ“ä½œï¼Œè¯·çŸ¥æ‚‰ã€ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ã€‘";
                $url = host_url . "/Enterprise/CustomerServices/orderDetail?type=".$repairData['order_type']."&order_id=".$orderId;
                break;
            case 4:
                $agentid = self::CUSTOMER_SERVICE;
                $title = "å”®åè®¢å•æé†’ï¼";
                $description = "æ‚¨å¥½ï¼Œè®¢å•å·".$repairData['order_code']."çš„è®¢å•å·²ç”³è¯·å”®åæœåŠ¡ï¼Œè¯·æŸ¥çœ‹å¹¶åŠæ—¶æ´¾å•ã€ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ã€‘";
                $url = host_url . "/Enterprise/CustomerServices/orderDetail?type=".$repairData['order_type']."&order_id=".$orderId;
                break;
            case 5:
                $agentid = self::CUSTOMER_SERVICE;
                $title = "çƒŸé“æ¸…æ´—æé†’ï¼";
                $description = "æ‚¨å¥½ï¼Œè®¢å•å·".$repairData['order_code']."çš„è®¢å•è·ç¦»çƒŸé“æ¸…æ´—å‘¨æœŸè¿˜æœ‰5å¤©ï¼Œè¯·æé†’ç”¨æˆ·åŠæ—¶ä¸‹æ–°è®¢å•ã€ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ã€‘";
                $url = host_url . "/Enterprise/CustomerServices/orderDetail?type=".$repairData['order_type']."&order_id=".$orderId;
                break;
            case 6:
                $agentid = self::CUSTOMER_SERVICE;
                $title = "çƒŸé“æ¸…æ´—æé†’ï¼";
                $description = "æ‚¨å¥½ï¼Œè®¢å•å·".$repairData['order_code']."çš„è®¢å•è·ç¦»çƒŸé“æ¸…æ´—å‘¨æœŸè¿˜æœ‰2å¤©ï¼Œè¯·æé†’ç”¨æˆ·åŠæ—¶ä¸‹æ–°è®¢å•ã€ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ã€‘";
                $url = host_url . "/Enterprise/CustomerServices/orderDetail?type=".$repairData['order_type']."&order_id=".$orderId;
                break;
            case 7:
                $agentid = self::CUSTOMER_SERVICE;
                $title = "å››å®³æ¶ˆæ€æé†’ï¼";
                $description = "æ‚¨å¥½ï¼Œè®¢å•å·".$repairData['order_code']."çš„è®¢å•è·ç¦»æ¶ˆæ€å‘¨æœŸè¿˜æœ‰5å¤©ï¼Œè¯·æé†’ç”¨æˆ·åŠæ—¶ä¸‹æ–°è®¢å•ã€ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ã€‘";
                $url = host_url . "/Enterprise/CustomerServices/orderDetail?type=".$repairData['order_type']."&order_id=".$orderId;
                break;
            case 8:
                $agentid = self::CUSTOMER_SERVICE;
                $title = "å››å®³æ¶ˆæ€æé†’ï¼";
                $description = "æ‚¨å¥½ï¼Œè®¢å•å·".$repairData['order_code']."çš„è®¢å•è·ç¦»æ¶ˆæ€å‘¨æœŸè¿˜æœ‰2å¤©ï¼Œè¯·æé†’ç”¨æˆ·åŠæ—¶ä¸‹æ–°è®¢å•ã€ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ã€‘";
                $url = host_url . "/Enterprise/CustomerServices/orderDetail?type=".$repairData['order_type']."&order_id=".$orderId;
                break;
        }

        $param = [
            'msgtype'=> 'news',
            'agentid'=>$agentid,
            'touser'=>$toUser,
            'news'=> [
                'articles'=>[
                    [
                        'title'=>$title,
                        'description'=>$description,
                        'url'=>$url,
                        'picurl'=>''
                    ]
                ]
            ]
        ];

        $param = json_encode($param,JSON_UNESCAPED_UNICODE);

        return $param;
    }
    /**
     * è·å–åˆ†é…ä¸»ç®¡å‘æ¶ˆæ¯å†…å®¹
     * @param $repairId
     * @param $type
     * @return array|string
     * @author pangyongfu
     */
    public function getDistributeSendMsg($orderId,$type){

        $toUser = null;
        $description = '';
        $agentid = 0;
        $title = '';
        $url = '';
        $wechatOrderModel = new WechatOrderModel();
        $map['orde.id'] = $orderId;
        $field = "orde.id,orde.order_code,orde.order_state,orde.create_time,orde.store_name,item.difference_status,item.difference_status,
        orde.order_type,orde.money_total,member.name worker,member.uid,faci.id fid,faci.name fname";
        $repairData = $wechatOrderModel->getDataByOrderId($map,$field);
        $repairData = $repairData[0];
        $repairData['order_type_text'] = $repairData['order_type']==1?"é—¨åº—ç»´ä¿®":($repairData['order_type']==2?"é—¨åº—æ¶ˆæ€":"é—¨åº—æ¸…æ´—");

        $repairData['order_state_text'] = $this->getOrderStatusText($repairData['order_state']);
        $description .= "å·¥å•ç¼–å·ï¼š".$repairData['order_code']."\r\n";
        $description .= "æŠ¥ä¿®é—¨åº—ï¼š".$repairData['store_name']."\r\n";
        $description .= "æŠ¥ä¿®æ—¶é—´ï¼š".$repairData['create_time']."\r\n";
        $description .= "å½“å‰çŠ¶æ€ï¼š".$repairData['order_state_text']."\r\n";
        if($repairData['order_type']==2 && $repairData['order_type']==2){
            $repairData['money_total'] += $repairData['difference_price'];
        }
        //è·å–æ‰€æœ‰åˆ†é…ä¸»ç®¡äººå‘˜
        $wechatMemberModel = new WechatMemberModel();
        $serviceArr = $wechatMemberModel->where(['isadmin'=>self::ADMIN_DISTRIBUTE,'status'=>1,'facilitator_id'=>$repairData['fid']])->select();

        $serviceArrWxCodeArr = [];
        if(!empty($serviceArr)){
            foreach ($serviceArr as $v) {
                $serviceArrWxCodeArr[] = $v['wx_code'];
            }
        }
        $serviceWxCode = implode("|",$serviceArrWxCodeArr);
        $toUser = $serviceWxCode;
        //å‘é€æ¶ˆæ¯ç±»å‹ 1å®¢æˆ·ä¸‹å•å 2å®¢æˆ·å–æ¶ˆè®¢å• 3å¸ˆå‚…æ¥å•å 4å®¢æˆ·æ”¯ä»˜å 5å®¢æˆ·éªŒæ”¶å®Œæ¯•ï¼ˆæ¶ˆæ€ï¼‰
        switch($type){
            case 1:
                $title = "æ–°è®¢å•æé†’ï¼";
                $description = "æ‚¨å¥½ï¼Œé¤è®¯ç½‘ç»™æ‚¨åˆ†æ´¾äº†ã€".$repairData['order_type_text']."ã€‘çš„æ–°è®¢å•ï¼Œè®¢å•å·ã€".$repairData['order_code']."ã€‘ï¼Œè¯·æŸ¥çœ‹å¹¶åŠæ—¶æ“ä½œè®¢å•åˆ†é…ã€ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ã€‘";
                $url = host_url . "/Enterprise/DistributionSupervisor/orderDetail?type=".$repairData['order_type']."&order_id=".$orderId."&fid=".$repairData['fid'];
                break;
            case 2:
                $title = "è®¢å•çŠ¶æ€æé†’ï¼";
                $description = "æ‚¨å¥½ï¼Œè®¢å•å·ä¸ºï¼š".$repairData['order_code']."çš„ã€".$repairData['order_type_text']."ã€‘è®¢å•å·²æ“ä½œå–æ¶ˆï¼Œæœ‰é—®é¢˜è¯·ä¸é¤è®¯ç½‘å®¢æœè”ç³»ï¼Œç”µè¯ï¼š18810250371ã€ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ã€‘";
                $url = host_url . "/Enterprise/DistributionSupervisor/orderDetail?type=".$repairData['order_type']."&order_id=".$orderId."&fid=".$repairData['fid'];;
                break;
            case 3://è®¢å•è¢«å®¢æœæ´¾å•ç»™ä¸»ç®¡
                $title = "è®¢å•çŠ¶æ€è¶…æ—¶æé†’ï¼";
                $description = "æ‚¨å¥½ï¼Œè®¢å•å·ä¸ºï¼š".$repairData['order_code']."çš„ã€".$repairData['order_type_text']."ã€‘è®¢å•æœªæ“ä½œæ´¾å•ï¼Œè¯·æ‚¨å°½å¿«æ“ä½œï¼Œç‰¹æ®ŠåŸå› è¯·è”ç³»å®¢æœå–æ¶ˆè®¢å•ï¼Œä»¥å…æ‚¨ä¼ä¸šç»¼åˆè¯„åˆ†å—æŸã€ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ã€‘";
                $url = host_url . "/Enterprise/DistributionSupervisor/orderDetail?type=".$repairData['order_type']."&order_id=".$orderId."&fid=".$repairData['fid'];;
                break;
            case 4://è®¢å•è¢«ä¸»ç®¡æ´¾å•ç»™å¸ˆå‚…
                $title = "è®¢å•çŠ¶æ€è¶…æ—¶æé†’ï¼";
                $description = "æ‚¨å¥½ï¼Œæ‚¨åˆ†é…çš„è®¢å•å·ä¸ºï¼š".$repairData['order_code']."çš„ã€".$repairData['order_type_text']."ã€‘è®¢å•å¸ˆå‚…é•¿æ—¶é—´æœªæ“ä½œæ¥å•ï¼Œè¯·å°½å¿«æé†’å¸ˆå‚…æ“ä½œæ¥å•æˆ–æ”¹æ´¾è®¢å•ï¼Œä»¥å…æ‚¨ä¼ä¸šç»¼åˆè¯„åˆ†å—æŸï¼›å–æ¶ˆè®¢å•è¯·è‡´ç”µï¼š18810250371ã€ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ã€‘";
                $url = host_url . "/Enterprise/DistributionSupervisor/orderDetail?type=".$repairData['order_type']."&order_id=".$orderId."&fid=".$repairData['fid'];;
                break;
            case 5:
                $title = "å”®åè®¢å•æé†’ï¼";
                $description = "æ‚¨å¥½ï¼Œè®¢å•å·ï¼š".$repairData['order_code']."ï¼Œç”¨æˆ·å·²ç”³è¯·å”®åæœåŠ¡ï¼Œè¯·è”ç³»ã€".$repairData['order_type_text']."ã€‘å¸ˆå‚…å¹¶åŠæ—¶å¤„ç†è®¢å•ã€ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ã€‘";
                $url = host_url . "/Enterprise/DistributionSupervisor/orderDetail?type=".$repairData['order_type']."&order_id=".$orderId."&fid=".$repairData['fid'];
                break;
//            case 6://æ¸…æ´—å’Œæ¶ˆæ€è®¢å•è¢«ä¸»ç®¡æ´¾å•ç»™å¸ˆå‚…1å°æ—¶30åˆ†é’Ÿå
//                $title = "è®¢å•çŠ¶æ€è¶…æ—¶æé†’ï¼";
//                $description = "æ‚¨å¥½ï¼Œæ‚¨åˆ†é…çš„è®¢å•å·ä¸ºï¼š".$repairData['order_code']."çš„ã€".$repairData['order_type_text']."ã€‘è®¢å•å¸ˆå‚…é•¿æ—¶é—´æœªæ“ä½œæ¥å•ï¼Œè¯·å°½å¿«æé†’å¸ˆå‚…æ“ä½œæ¥å•æˆ–æ”¹æ´¾è®¢å•ï¼Œä»¥å…æ‚¨ä¼ä¸šç»¼åˆè¯„åˆ†å—æŸï¼›å–æ¶ˆè®¢å•è¯·è‡´ç”µï¼š188888ã€ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ã€‘";
//                $url = host_url . "/Enterprise/DistributionSupervisor/orderDetail?type=".$repairData['order_type']."&order_id=".$orderId."&fid=".$repairData['fid'];;
//                break;
            case 7://æ¶ˆæ€ä¸»ç®¡æ¥å•å
                $title = "è®¢å•çŠ¶æ€æé†’ï¼";
                $url = host_url . "/Enterprise/DistributionSupervisor/orderDetail?type=".$repairData['order_type']."&order_id=".$orderId."&fid=".$repairData['fid'];
                $description = "æ‚¨å¥½ï¼Œè®¢å•å·ï¼š".$repairData['order_code']."å·²æ“ä½œæ¥å•ï¼Œè¯·æ‚¨å°½å¿«è¿›è¡Œå¤„ç†ï¼Œä»¥å…å¼•èµ·å®¢è¯‰";
                break;
            case 8://ç»´ä¿®å’Œæ¸…æ´—ä¸»ç®¡æ¥å•å
                $title = "è®¢å•çŠ¶æ€æé†’ï¼";
                if($repairData['order_type'] == 1){
                    $text = "ç»´ä¿®å¸ˆå‚…ç«¯";
                    $url = host_url . "/Enterprise/DistributionSupervisor/maintainOrderDetail?order_id=".$orderId;
                }else{
                    $text = "æ¸…æ´—å¸ˆå‚…ç«¯";
                    $url = host_url . "/Enterprise/DistributionSupervisor/cleaningOrderDetail?order_id=".$orderId;
                }
                $description = "æ‚¨å¥½ï¼Œè®¢å•å·ï¼š".$repairData['order_code']."å·²æ“ä½œæ¥å•ï¼Œè¯·åˆ°".$text."æŸ¥çœ‹è¯¦æƒ…å¹¶è¿›è¡Œå…¶ä»–æ“ä½œ";
                break;
        }

        $agentid = self::DISTRIBUTE_MANAGER;
        $param = [
            'msgtype'=> 'news',
            'agentid'=>$agentid,
            'touser'=>$toUser,
            'news'=> [
                'articles'=>[
                    [
                        'title'=>$title,
                        'description'=>$description,
                        'url'=>$url,
                        'picurl'=>''
                    ]
                ]
            ]
        ];

        $param = json_encode($param,JSON_UNESCAPED_UNICODE);

        return $param;
    }
    /**
     * è·å–å¸ˆå‚…å‘æ¶ˆæ¯å†…å®¹
     * @param $repairId
     * @param $type
     * @return array|string
     * @author pangyongfu
     */
    public function getMasterSendMsg($orderId,$type){

        $toUser = null;
        $description = '';
        $agentid = 0;
        $title = '';
        $url = '';
        $wechatOrderModel = new WechatOrderModel();
        $map['orde.id'] = $orderId;
        $field = "orde.id,orde.order_code,orde.order_state,orde.create_time,orde.store_name,item.difference_status,item.difference_status,
        orde.order_type,orde.money_total,member.name worker,member.uid,faci.id fid,faci.name fname";
        $repairData = $wechatOrderModel->getDataByOrderId($map,$field);
        $repairData = $repairData[0];
        log::write("è®¢å•æ•°æ®ï¼š".json_encode($repairData));
        $repairData['order_type_text'] = $repairData['order_type']==1?"é—¨åº—ç»´ä¿®":($repairData['order_type']==2?"é—¨åº—æ¶ˆæ€":"é—¨åº—æ¸…æ´—");

        $repairData['order_state_text'] = $this->getOrderStatusText($repairData['order_state']);
        $description .= "å·¥å•ç¼–å·ï¼š".$repairData['order_code']."\r\n";
        $description .= "æŠ¥ä¿®é—¨åº—ï¼š".$repairData['store_name']."\r\n";
        $description .= "æŠ¥ä¿®æ—¶é—´ï¼š".$repairData['create_time']."\r\n";
        $description .= "å½“å‰çŠ¶æ€ï¼š".$repairData['order_state_text']."\r\n";
        if($repairData['order_type']==2 && $repairData['order_type']==2){
            $repairData['money_total'] += $repairData['difference_price'];
        }
        //è·å–æ‰€æœ‰å®¢æœäººå‘˜
        $wechatMemberModel = new WechatMemberModel();
        $serviceArr = $wechatMemberModel->where(['isadmin'=>self::ADMIN_NOMAL,'status'=>1,'uid'=>$repairData['uid']])->select();

        $serviceArrWxCodeArr = [];
        if(!empty($serviceArr)){
            foreach ($serviceArr as $v) {
                $serviceArrWxCodeArr[] = $v['wx_code'];
            }
        }
        $serviceWxCode = implode("|",$serviceArrWxCodeArr);
        $toUser = $serviceWxCode;
        //å‘é€æ¶ˆæ¯ç±»å‹ 1å®¢æˆ·ä¸‹å•å 2å®¢æˆ·å–æ¶ˆè®¢å• 3å¸ˆå‚…æ¥å•å 4å®¢æˆ·æ”¯ä»˜å 5å®¢æˆ·éªŒæ”¶å®Œæ¯•ï¼ˆæ¶ˆæ€ï¼‰
        switch($type){
            case 1:
                $title = "æ–°å·¥å•æé†’ï¼";
                $description = "æ‚¨å¥½ï¼Œæ‚¨æœ‰æ–°è®¢å•ï¼Œè¯·å°½å¿«ä¸ç”¨æˆ·ç”µè¯è”ç³»ï¼Œå¹¶æ“ä½œæ¥å•ã€ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ã€‘";
                break;
            case 2://è®¢å•è¶…è¿‡ä¸€å®šæ—¶é—´å¸ˆå‚…æœªæ¥å•
                $title = "è®¢å•çŠ¶æ€è¶…æ—¶æé†’ï¼";
                $description = "æ‚¨å¥½ï¼Œè®¢å•å·ï¼š".$repairData['order_code']."æœªæ“ä½œæ¥å•ï¼Œè¯·æ‚¨å°½å¿«æ“ä½œï¼Œç‰¹æ®ŠåŸå› è¯·è”ç³»æ‚¨çš„è®¢å•åˆ†é…ä¸»ç®¡å–æ¶ˆè®¢å•ï¼Œä»¥å…æ‚¨ä¼ä¸šç»¼åˆè¯„åˆ†å—æŸã€ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ã€‘";
                break;
            case 3://æ¶ˆæ€å¸ˆå‚…æ¥å•å
                $title = "è®¢å•çŠ¶æ€æé†’ï¼";
                $description = "æ‚¨å¥½ï¼Œè®¢å•å·ï¼š".$repairData['order_code']."å·²æ“ä½œæ¥å•ï¼Œè¯·åœ¨1å°æ—¶å†…ä¸ç”¨æˆ·å–å¾—è”ç³»ï¼Œä»¥å…å¼•èµ·å®¢è¯‰ã€ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ã€‘";
                break;
            case 4://æ¶ˆæ€å’Œæ¸…æ´—è®¢å•è¶…è¿‡1å°æ—¶20åˆ†é’Ÿå¸ˆå‚…æœªæ¥å•
                $title = "è®¢å•çŠ¶æ€æé†’ï¼";
                $description = "æ‚¨å¥½ï¼Œè®¢å•å·ï¼š".$repairData['order_code']."å·²æ“ä½œæ¥å•ï¼Œè¯·ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…å¹¶è¿›è¡Œå…¶ä»–æ“ä½œã€ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ã€‘";
                break;
            case 5://å®¢æœå–æ¶ˆè®¢å•å
                $title = "è®¢å•çŠ¶æ€æé†’ï¼";
                $description = "æ‚¨å¥½ï¼Œè®¢å•å·ä¸ºï¼š".$repairData['order_code']."çš„è®¢å•å·²ç”±å®¢æœæ“ä½œå–æ¶ˆï¼Œæœ‰é—®é¢˜è¯·ä¸é¤è®¯ç½‘å®¢æœè”ç³»ï¼Œç”µè¯ï¼š18810250371ã€ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ã€‘";
                break;
            case 6://æ¶ˆæ€å®Œæˆå·®ä»·æ”¯ä»˜
                $title = "è®¢å•çŠ¶æ€æé†’ï¼";
                $description = "æ‚¨å¥½ï¼Œæ‚¨æœåŠ¡çš„è®¢å•å·ï¼š".$repairData['order_code']."ï¼Œç”¨æˆ·å·²å®Œæˆå·®ä»·æ”¯ä»˜ã€ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ã€‘";
                break;
            case 7://æ¸…æ´—å’Œç»´ä¿®å®Œæˆæ”¯ä»˜
                $title = "è®¢å•çŠ¶æ€æé†’ï¼";
                $description = "æ‚¨å¥½ï¼Œæ‚¨æœåŠ¡çš„è®¢å•å·ï¼š".$repairData['order_code']."ï¼Œç”¨æˆ·å·²å®Œæˆæ”¯ä»˜ã€ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ã€‘";
                break;
            case 8:
                $title = "å”®åå·¥å•æé†’ï¼";
                $description = "æ‚¨å¥½ï¼Œæ‚¨æœåŠ¡çš„è®¢å•å·ï¼š".$repairData['order_code']."ï¼Œç”¨æˆ·å·²ç”³è¯·å”®åæœåŠ¡ï¼Œè¯·å°½å¿«ä¸ç”¨æˆ·ç”µè¯è”ç³»ã€ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ã€‘";
                break;
        }
        //1é—¨åº—ç»´ä¿®ï¼Œ2é—¨åº—æ¶ˆæ€ï¼Œ3çƒŸé“æ¸…æ´—
        if($repairData['order_type'] == 1){
            $agentid = self::REPAIRE_MASTER;
            $url = host_url . "/Enterprise/StoreMaintain/orderDetail?order_id=".$orderId;
        }elseif($repairData['order_type'] == 2){
            $agentid = self::CLEANKILL_MASTER;
            $url = host_url . "/Enterprise/StoreCleanKill/orderDetail?order_id=".$orderId;
        }else{
            $agentid = self::CLEANING_MASTER;
            $url = host_url . "/Enterprise/StoreCleaning/orderDetail?order_id=".$orderId;
        }
        $param = [
            'msgtype'=> 'news',
            'agentid'=>$agentid,
            'touser'=>$toUser,
            'news'=> [
                'articles'=>[
                    [
                        'title'=>$title,
                        'description'=>$description,
                        'url'=>$url,
                        'picurl'=>''
                    ]
                ]
            ]
        ];

        $param = json_encode($param,JSON_UNESCAPED_UNICODE);

        return $param;
    }

    //å‘é€å›¾æ–‡æ¶ˆæ¯
    public function sendPicTextMsg($wxCode,$order_type,$title,$description,$url,$pic = ''){

        //1é—¨åº—ç»´ä¿®ï¼Œ2é—¨åº—æ¶ˆæ€ï¼Œ3çƒŸé“æ¸…æ´—
        $agentid = self::DISTRIBUTE_MANAGER;

        $param = [
            'msgtype'=> 'news',
            'agentid'=>$agentid,
            'touser'=>$wxCode,
            'news'=> [
                'articles'=>[
                    [
                        'title'=>$title,
                        'description'=>$description,
                        'url'=>$url,
                        'picurl'=>$pic
                    ]
                ]
            ]
        ];

        $param = json_encode($param,JSON_UNESCAPED_UNICODE);
        $this->sendMessage($param);
    }
}

?>